# 데이터베이스 설계 명세서 v1.0

**작성일**: 2025-01-XX
**스키마 버전**: 001
**DBMS**: PostgreSQL 15 (Supabase)
**상태**: 확정 및 배포 완료

---

## ⚠️ 중요 공지

**이 문서는 실제 배포된 데이터베이스의 정확한 스키마입니다.**

- 추정 없음: 모든 컬럼, 타입, 제약조건은 실제 배포됨
- SQL 파일: `database/schema_001_initial.sql`과 100% 일치
- 변경 시: 마이그레이션 스크립트 필수

---

## 1. 데이터베이스 정보

```yaml
제공자: Supabase
엔진: PostgreSQL 15.1
프로젝트 ID: hrmtuwuxbspudguecyrp
호스트: db.hrmtuwuxbspudguecyrp.supabase.co
포트: 5432
데이터베이스명: postgres
스키마: public
문자 인코딩: UTF-8
타임존: UTC
```

---

## 2. 테이블 목록

| 테이블명 | 설명 | 행 수 (예상) | 상태 |
|----------|------|-------------|------|
| `places` | 장소 정보 (식당, 카페, 팝업 등) | 0~1000 | ✅ 배포됨 |
| `auth.users` | 사용자 (Supabase 자동 생성) | 1 | ✅ 자동 |

**Phase 2 예정**:
- `categories` (사용자 정의 카테고리)
- `tags` (키워드 자동완성용)

---

## 3. places 테이블 상세 명세

### 3.1 테이블 정의

```sql
CREATE TABLE places (
    -- 기본 키
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,

    -- 기본 정보
    name VARCHAR(255) NOT NULL,
    category VARCHAR(50) NOT NULL
        CHECK (category IN ('식당', '카페', '문화/여가', '명소', '팝업/축제')),

    -- 상태 정보
    visit_status VARCHAR(30) NOT NULL DEFAULT '미방문'
        CHECK (visit_status IN ('미방문', '방문 완료', '재방문 완료')),
    priority VARCHAR(30) NOT NULL DEFAULT '일반'
        CHECK (priority IN ('🔥 최우선', '✨ 꼭 가볼 곳', '일반')),
    record_status VARCHAR(20) NOT NULL DEFAULT 'published'
        CHECK (record_status IN ('draft', 'published')),

    -- 지역 정보
    region_main VARCHAR(50),
    region_sub VARCHAR(50),
    address TEXT,

    -- 영업 정보
    operating_hours TEXT,

    -- 주차 정보
    parking_info VARCHAR(50)
        CHECK (parking_info IN ('매장 주차장', '주차 지원', '인근 공영/유료', '주차 불가')),
    parking_memo TEXT,

    -- 추가 정보
    keywords TEXT[],
    memo TEXT,
    source_url VARCHAR(500),
    cover_image_url VARCHAR(500),

    -- 팝업/축제용 (선택적)
    start_date DATE,
    end_date DATE,

    -- 시스템 정보
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

### 3.2 컬럼 상세 설명

| 컬럼명 | 타입 | NULL | 기본값 | 설명 |
|--------|------|------|--------|------|
| `id` | UUID | NO | uuid_generate_v4() | 고유 식별자 (PK) |
| `user_id` | UUID | YES | NULL | 작성자 (auth.users FK) |
| `name` | VARCHAR(255) | NO | - | 장소명 (예: "제미니네 파스타") |
| `category` | VARCHAR(50) | NO | - | 카테고리 (5개 값만 허용) |
| `visit_status` | VARCHAR(30) | NO | '미방문' | 방문 상태 (3개 값만) |
| `priority` | VARCHAR(30) | NO | '일반' | 우선순위 (3개 값만) |
| `record_status` | VARCHAR(20) | NO | 'published' | draft=Quick Save, published=완전 |
| `region_main` | VARCHAR(50) | YES | NULL | 시/도 (예: "부산") |
| `region_sub` | VARCHAR(50) | YES | NULL | 구/군 (예: "해운대구") |
| `address` | TEXT | YES | NULL | 전체 주소 (네비용) |
| `operating_hours` | TEXT | YES | NULL | 영업시간 자유 텍스트 |
| `parking_info` | VARCHAR(50) | YES | NULL | 주차 정보 (4개 값만) |
| `parking_memo` | TEXT | YES | NULL | 주차 상세 설명 |
| `keywords` | TEXT[] | YES | NULL | 키워드 배열 (예: {'한식','국밥'}) |
| `memo` | TEXT | YES | NULL | 자유 메모 |
| `source_url` | VARCHAR(500) | YES | NULL | 출처 링크 (인스타 등) |
| `cover_image_url` | VARCHAR(500) | YES | NULL | Supabase Storage 경로 |
| `start_date` | DATE | YES | NULL | 팝업 시작일 |
| `end_date` | DATE | YES | NULL | 팝업 종료일 |
| `created_at` | TIMESTAMP | NO | NOW() | 생성 일시 (자동) |
| `updated_at` | TIMESTAMP | NO | NOW() | 수정 일시 (자동) |

### 3.3 CHECK 제약조건 (열거형)

```sql
-- category: 5개 값만 허용
category IN ('식당', '카페', '문화/여가', '명소', '팝업/축제')

-- visit_status: 3개 값만 허용
visit_status IN ('미방문', '방문 완료', '재방문 완료')

-- priority: 3개 값만 허용
priority IN ('🔥 최우선', '✨ 꼭 가볼 곳', '일반')

-- record_status: 2개 값만 허용
record_status IN ('draft', 'published')

-- parking_info: 4개 값만 허용
parking_info IN ('매장 주차장', '주차 지원', '인근 공영/유료', '주차 불가')

-- 팝업 기간: 종료일 >= 시작일
CHECK (
    (start_date IS NULL AND end_date IS NULL) OR
    (start_date IS NOT NULL AND end_date IS NOT NULL AND end_date >= start_date)
)
```

---

## 4. 인덱스

### 4.1 인덱스 목록

```sql
-- 기본 키 (자동 생성)
PRIMARY KEY (id)

-- 외래 키 (자동 생성)
FOREIGN KEY (user_id) REFERENCES auth.users(id)

-- 성능 최적화 인덱스
CREATE INDEX idx_places_user ON places(user_id);
CREATE INDEX idx_places_category ON places(category);
CREATE INDEX idx_places_visit_status ON places(visit_status);
CREATE INDEX idx_places_priority ON places(priority);
CREATE INDEX idx_places_record_status ON places(record_status);
CREATE INDEX idx_places_region_main ON places(region_main);
CREATE INDEX idx_places_created_at ON places(created_at DESC);
CREATE INDEX idx_places_updated_at ON places(updated_at DESC);

-- 배열 검색 최적화 (GIN 인덱스)
CREATE INDEX idx_places_keywords ON places USING GIN(keywords);

-- 복합 인덱스 (자주 사용되는 조합)
CREATE INDEX idx_places_user_category ON places(user_id, category);
CREATE INDEX idx_places_user_visit_status ON places(user_id, visit_status);
CREATE INDEX idx_places_user_priority ON places(user_id, priority DESC, created_at DESC);
```

### 4.2 인덱스 사용 목적

| 인덱스명 | 컬럼 | 목적 | 예상 쿼리 |
|----------|------|------|----------|
| idx_places_user | user_id | 사용자별 조회 | WHERE user_id = ? |
| idx_places_category | category | 카테고리 필터 | WHERE category = '식당' |
| idx_places_visit_status | visit_status | 방문 상태 필터 | WHERE visit_status = '미방문' |
| idx_places_priority | priority | 우선순위 정렬 | ORDER BY priority DESC |
| idx_places_keywords | keywords | 키워드 검색 | WHERE keywords && ARRAY['한식'] |
| idx_places_user_priority | user_id, priority, created_at | 대시보드 쿼리 | WHERE user_id = ? ORDER BY priority, created_at |

---

## 5. Row Level Security (RLS)

### 5.1 RLS 활성화

```sql
ALTER TABLE places ENABLE ROW LEVEL SECURITY;
```

### 5.2 정책 목록

#### 정책 1: SELECT (조회)
```sql
CREATE POLICY "Users can view own places"
    ON places FOR SELECT
    USING (auth.uid() = user_id);
```

**의미**: 사용자는 자신의 `user_id`와 일치하는 행만 조회 가능

#### 정책 2: INSERT (삽입)
```sql
CREATE POLICY "Users can insert own places"
    ON places FOR INSERT
    WITH CHECK (auth.uid() = user_id);
```

**의미**: 삽입 시 `user_id`가 자신의 `auth.uid()`와 일치해야 함

#### 정책 3: UPDATE (수정)
```sql
CREATE POLICY "Users can update own places"
    ON places FOR UPDATE
    USING (auth.uid() = user_id)
    WITH CHECK (auth.uid() = user_id);
```

**의미**: 자신의 데이터만 수정 가능, 수정 후에도 `user_id` 유지

#### 정책 4: DELETE (삭제)
```sql
CREATE POLICY "Users can delete own places"
    ON places FOR DELETE
    USING (auth.uid() = user_id);
```

**의미**: 자신의 데이터만 삭제 가능

### 5.3 RLS 테스트

```sql
-- 테스트 사용자로 로그인 (Supabase Dashboard)
-- user_id = 'abc-123' 가정

-- 성공 (자신의 데이터)
SELECT * FROM places WHERE user_id = 'abc-123';  -- 조회됨

-- 실패 (타인의 데이터)
SELECT * FROM places WHERE user_id = 'def-456';  -- 조회 안 됨 (0 rows)

-- 삽입 시도 (타인 user_id)
INSERT INTO places (user_id, name, category)
VALUES ('def-456', 'test', '식당');  -- 오류 발생
```

---

## 6. 트리거

### 6.1 updated_at 자동 갱신

```sql
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE 'plpgsql';

CREATE TRIGGER update_places_updated_at
    BEFORE UPDATE ON places
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();
```

**동작**:
1. `UPDATE` 문 실행 시 트리거 발동
2. `updated_at` 컬럼 자동으로 현재 시각으로 설정
3. 사용자가 `updated_at`을 수동으로 설정할 필요 없음

---

## 7. 데이터 예시

### 7.1 식당 데이터

```sql
INSERT INTO places (
    user_id, name, category, visit_status, priority,
    region_main, region_sub, address,
    keywords, memo, source_url
) VALUES (
    auth.uid(),
    '제미니네 쭈꾸미',
    '식당',
    '미방문',
    '🔥 최우선',
    '부산',
    '해운대구',
    '부산 해운대구 중동 123-45',
    ARRAY['한식', '쭈꾸미', '야장'],
    '11:30-22:00, 월요일 휴무, 주차 2대 가능',
    'https://instagram.com/p/...'
);
```

### 7.2 팝업 데이터

```sql
INSERT INTO places (
    user_id, name, category, visit_status, priority,
    region_main, start_date, end_date,
    keywords, memo
) VALUES (
    auth.uid(),
    '벚꽃 축제',
    '팝업/축제',
    '미방문',
    '✨ 꼭 가볼 곳',
    '부산',
    '2025-04-01',
    '2025-04-10',
    ARRAY['축제', '봄', '벚꽃'],
    '입장료 무료, 주차 인근 공영주차장'
);
```

### 7.3 Quick Save (draft)

```sql
INSERT INTO places (
    user_id, name, category, record_status, source_url
) VALUES (
    auth.uid(),
    '여친님 추천 파스타집',
    '식당',
    'draft',
    'https://instagram.com/p/...'
);
```

---

## 8. 쿼리 패턴 (실제 사용)

### 8.1 전체 조회 (우선순위 정렬)

```sql
SELECT *
FROM places
WHERE user_id = auth.uid()
ORDER BY
    CASE priority
        WHEN '🔥 최우선' THEN 1
        WHEN '✨ 꼭 가볼 곳' THEN 2
        WHEN '일반' THEN 3
    END,
    created_at DESC;
```

### 8.2 필터링 (카테고리 + 방문상태)

```sql
SELECT *
FROM places
WHERE user_id = auth.uid()
  AND category = '식당'
  AND visit_status = '미방문'
ORDER BY priority DESC, created_at DESC;
```

### 8.3 키워드 검색

```sql
SELECT *
FROM places
WHERE user_id = auth.uid()
  AND keywords && ARRAY['한식', '야장']  -- 배열 교집합
ORDER BY created_at DESC;
```

### 8.4 통합 검색 (이름 + 키워드 + 지역)

```sql
SELECT *
FROM places
WHERE user_id = auth.uid()
  AND (
    name ILIKE '%부산%'
    OR region_main ILIKE '%부산%'
    OR region_sub ILIKE '%부산%'
    OR '부산' = ANY(keywords)
  )
ORDER BY created_at DESC;
```

---

## 9. 스토리지 (place-images)

### 9.1 버킷 정보

```yaml
버킷명: place-images
공개 여부: Public (읽기만)
파일 경로 형식: {user_id}/{place_id}/{filename}
예시: abc-123/def-456/photo1.jpg
```

### 9.2 정책

```sql
-- 누구나 조회 가능
CREATE POLICY "Public images are viewable by everyone"
ON storage.objects FOR SELECT
USING ( bucket_id = 'place-images' );

-- 인증된 사용자만 업로드
CREATE POLICY "Authenticated users can upload images"
ON storage.objects FOR INSERT
WITH CHECK (
    bucket_id = 'place-images'
    AND auth.role() = 'authenticated'
);

-- 본인 파일만 삭제
CREATE POLICY "Users can delete own images"
ON storage.objects FOR DELETE
USING (
    bucket_id = 'place-images'
    AND auth.uid() = owner
);
```

### 9.3 이미지 URL 생성

```typescript
// 업로드
const { data, error } = await supabase.storage
    .from('place-images')
    .upload(`${user_id}/${place_id}/photo.jpg`, file);

// 공개 URL 생성
const { data: { publicUrl } } = supabase.storage
    .from('place-images')
    .getPublicUrl(`${user_id}/${place_id}/photo.jpg`);

// places 테이블에 저장
await supabase
    .from('places')
    .update({ cover_image_url: publicUrl })
    .eq('id', place_id);
```

---

## 10. 백업 및 마이그레이션

### 10.1 백업

```bash
# pg_dump로 백업 (수동)
pg_dump -h db.hrmtuwuxbspudguecyrp.supabase.co \
        -U postgres \
        -d postgres \
        -t places \
        > backup_places_20250101.sql

# Supabase 자동 백업
# 무료 플랜: 7일간 자동 백업 (일일 스냅샷)
```

### 10.2 마이그레이션 규칙

```
스키마 변경 시:
1. 새 SQL 파일 생성: schema_002_description.sql
2. ALTER TABLE 사용 (DROP 금지)
3. 백업 후 실행
4. Rollback 스크립트 준비
```

---

## 11. 성능 지표 (예상)

| 작업 | 데이터 100개 | 데이터 1000개 | 인덱스 사용 |
|------|-------------|--------------|-------------|
| 전체 조회 | < 50ms | < 100ms | ✅ idx_places_user_priority |
| 카테고리 필터 | < 30ms | < 80ms | ✅ idx_places_user_category |
| 키워드 검색 | < 40ms | < 90ms | ✅ idx_places_keywords (GIN) |
| 단일 조회 (PK) | < 5ms | < 5ms | ✅ PRIMARY KEY |

---

## 12. 변경 이력

| 버전 | 날짜 | 변경 내용 | 작성자 |
|------|------|----------|--------|
| 001 | 2025-01-XX | 초기 스키마 생성 및 배포 | sungmoon2 |

---

**이 스키마는 실제 배포되어 운영 중입니다.**
**변경 시 반드시 마이그레이션 계획 수립 후 진행**
